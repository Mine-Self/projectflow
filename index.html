<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ××©×™××•×ª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: 'Assistant', 'Inter', sans-serif;
        }
        .modal, .login-modal {
            display: none; /* Hidden by default */
            position: fixed; 
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }
        .modal-content, .login-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }
        .login-modal { display: flex; align-items: center; justify-content: center; padding-top: 0;}
        .login-modal-content { margin: auto; }

        .close-button {
            color: #aaa;
            position: absolute;
            left: 15px; /* Adjusted for RTL, close button on the left */
            top: 10px;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .rtl-form-input, .rtl-select {
            text-align: right;
        }
        .rtl-table th, .rtl-table td {
            text-align: right;
            padding-right: 0.75rem; 
            padding-left: 0.75rem; 
        }
        .rtl-table th:first-child, .rtl-table td:first-child { padding-right: 1.5rem; }
        .rtl-table th:last-child, .rtl-table td:last-child { padding-left: 1.5rem; }
        
        .status-new { background-color: #E0E7FF; color: #3730A3; }
        .status-in-progress { background-color: #FEF3C7; color: #92400E; }
        .status-completed { background-color: #D1FAE5; color: #065F46; }
        .status-pending { background-color: #FEF9C3; color: #854D0E; } /* Yellow-100, Yellow-700 */
        .status-cancelled { background-color: #FEE2E2; color: #991B1B; } /* Red-100, Red-700 */

        /* FullCalendar RTL adjustments */
        .fc-header-toolbar {
            direction: rtl; /* Ensure header is RTL */
        }
        .fc-toolbar-chunk:first-child { order: 3; } /* Moves title to the right */
        .fc-toolbar-chunk:nth-child(2) { order: 2; } /* Keeps center buttons in center */
        .fc-toolbar-chunk:last-child { order: 1; } /* Moves prev/next/today to the left */
        .fc-event-main { direction: rtl; text-align: right;}

        #appContainer { display: none; } /* Hidden until authenticated */
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loginModal" class="login-modal" style="display: flex;">
        <div class="login-modal-content">
            <h2 class="text-2xl font-semibold text-indigo-600 mb-4 text-center">×›× ×™×¡×” ×œ××¢×¨×›×ª</h2>
            <p class="text-sm text-gray-600 mb-4 text-center">×–×•×”×™ ××¢×¨×›×ª ×”×“×’××” ×¢× ××™××•×ª ×‘×¡×™×¡×™ ×‘×¦×“ ×”×œ×§×•×— ×‘×œ×‘×“.</p>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">×›×ª×•×‘×ª ××™×™×œ:</label>
                    <input type="email" id="email" name="email" class="rtl-form-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                </div>
                <p id="loginError" class="text-red-500 text-sm mb-4" style="display: none;">×›×ª×•×‘×ª ××™×™×œ ×œ× ××•×¨×©×™×ª.</p>
                <button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">×”×ª×—×‘×¨</button>
            </form>
        </div>
    </div>

    <div id="appContainer" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-indigo-600">××¢×¨×›×ª × ×™×”×•×œ ××©×™××•×ª</h1>
            <p class="text-sm text-gray-500">××©×ª××© ××—×•×‘×¨: <span id="loggedInUserEmail"></span> <button id="logoutButton" class="text-indigo-500 hover:underline text-xs">(×”×ª× ×ª×§)</button></p>
        </header>

        <div class="mb-6 text-left">
            <button id="openModalButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                ×”×•×¡×£ ××©×™××” ×—×“×©×”
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-white rounded-lg shadow">
            <div>
                <label for="filterProject" class="block text-sm font-medium text-gray-700">×¡× ×Ÿ ×œ×¤×™ ×¤×¨×•×™×§×˜:</label>
                <input type="text" id="filterProject" class="rtl-form-input mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="filterAssignee" class="block text-sm font-medium text-gray-700">×¡× ×Ÿ ×œ×¤×™ ××—×¨××™:</label>
                <input type="text" id="filterAssignee" class="rtl-form-input mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="filterStatus" class="block text-sm font-medium text-gray-700">×¡× ×Ÿ ×œ×¤×™ ×¡×˜×˜×•×¡:</label>
                <select id="filterStatus" class="rtl-select mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">×”×›×œ</option>
                    <option value="×—×“×©">×—×“×©</option>
                    <option value="×‘×ª×”×œ×™×š">×‘×ª×”×œ×™×š</option>
                    <option value="×”×•×©×œ×">×”×•×©×œ×</option>
                    <option value="×‘×”××ª× ×”">×‘×”××ª× ×”</option>
                    <option value="×‘×•×˜×œ">×‘×•×˜×œ</option>
                </select>
            </div>
            <div>
                <label for="sortBy" class="block text-sm font-medium text-gray-700">××™×™×Ÿ ×œ×¤×™:</label>
                <select id="sortBy" class="rtl-select mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="id">×‘×¨×™×¨×ª ××—×“×œ (ID)</option>
                    <option value="name">×©× ××©×™××”</option>
                    <option value="dueDate">×ª××¨×™×š ×™×¢×“</option>
                    <option value="status">×¡×˜×˜×•×¡</option>
                </select>
            </div>
        </div>

        <div class="bg-white shadow-xl rounded-lg overflow-x-auto mb-8">
            <table class="min-w-full leading-normal rtl-table">
                <thead>
                    <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                        <th class="py-3 px-6">×©× ×”××©×™××”</th>
                        <th class="py-3 px-6">×¤×¨×•×™×§×˜</th>
                        <th class="py-3 px-6">××—×¨××™</th>
                        <th class="py-3 px-6">×ª××¨×™×š ×™×¢×“</th>
                        <th class="py-3 px-6">×¡×˜×˜×•×¡</th>
                        <th class="py-3 px-6">×¤×¢×•×œ×•×ª</th>
                    </tr>
                </thead>
                <tbody id="tasksTableBody" class="text-gray-700 text-sm">
                    </tbody>
            </table>
        </div>
        <p class="mt-4 text-sm text-gray-500 text-center">×¡×”"×› ××©×™××•×ª (×œ××—×¨ ×¡×™× ×•×Ÿ): <span id="taskCount">0</span></p>
        
        <div class="mt-10 bg-white shadow-xl rounded-lg p-4">
            <h2 class="text-2xl font-semibold text-indigo-600 mb-4 text-center">×œ×•×— ×©× ×”</h2>
            <div id="calendar"></div>
        </div>
    </div>

    <div id="taskModal" class="modal">
        <div class="modal-content">
            <span class="close-button cursor-pointer">&times;</span>
            <h2 id="modalTitle" class="text-2xl font-semibold text-indigo-600 mb-4">×”×•×¡×£ ××©×™××” ×—×“×©×”</h2>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                <div class="mb-4">
                    <label for="taskName" class="block text-sm font-medium text-gray-700 mb-1">×©× ×”××©×™××”:</label>
                    <input type="text" id="taskName" name="taskName" class="rtl-form-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                </div>
                <div class="mb-4">
                    <label for="taskProject" class="block text-sm font-medium text-gray-700 mb-1">×¤×¨×•×™×§×˜:</label>
                    <input type="text" id="taskProject" name="taskProject" class="rtl-form-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="mb-4">
                    <label for="taskAssignee" class="block text-sm font-medium text-gray-700 mb-1">××—×¨××™:</label>
                    <input type="text" id="taskAssignee" name="taskAssignee" class="rtl-form-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="mb-4">
                    <label for="taskDueDate" class="block text-sm font-medium text-gray-700 mb-1">×ª××¨×™×š ×™×¢×“:</label>
                    <input type="date" id="taskDueDate" name="taskDueDate" class="rtl-form-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="mb-4">
                    <label for="taskStatus" class="block text-sm font-medium text-gray-700 mb-1">×¡×˜×˜×•×¡:</label>
                    <select id="taskStatus" name="taskStatus" class="rtl-select mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="×—×“×©">×—×“×©</option>
                        <option value="×‘×ª×”×œ×™×š">×‘×ª×”×œ×™×š</option>
                        <option value="×”×•×©×œ×">×”×•×©×œ×</option>
                        <option value="×‘×”××ª× ×”">×‘×”××ª× ×”</option>
                        <option value="×‘×•×˜×œ">×‘×•×˜×œ</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="taskDescription" class="block text-sm font-medium text-gray-700 mb-1">×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™):</label>
                    <textarea id="taskDescription" name="taskDescription" rows="3" class="rtl-form-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div class="flex items-center justify-end pt-4 border-t">
                    <button type="button" id="cancelButton" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg ml-2 transition duration-150 ease-in-out">×‘×™×˜×•×œ</button>
                    <button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">×©××•×¨ ××©×™××”</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/he.js"></script>

    <script>
        const appContainer = document.getElementById('appContainer');
        const loginModal = document.getElementById('loginModal');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const loggedInUserEmailSpan = document.getElementById('loggedInUserEmail');
        const logoutButton = document.getElementById('logoutButton');

        const tasksTableBody = document.getElementById('tasksTableBody');
        const taskForm = document.getElementById('taskForm');
        const taskModal = document.getElementById('taskModal');
        const openModalButton = document.getElementById('openModalButton');
        const closeButton = taskModal.querySelector('.close-button');
        const cancelButton = document.getElementById('cancelButton');
        const modalTitle = document.getElementById('modalTitle');
        const taskIdInput = document.getElementById('taskId');
        const taskCountSpan = document.getElementById('taskCount');

        const filterProjectInput = document.getElementById('filterProject');
        const filterAssigneeInput = document.getElementById('filterAssignee');
        const filterStatusSelect = document.getElementById('filterStatus');
        const sortBySelect = document.getElementById('sortBy');

        let tasks = [];
        let calendar;
        const ALLOWED_EMAILS = ['mualex1970@gmail.com', 'alexmu14@gmail.com'];

        // --- Authentication ---
        function checkLogin() {
            const loggedInUser = sessionStorage.getItem('loggedInUser');
            if (loggedInUser && ALLOWED_EMAILS.includes(loggedInUser)) {
                loginModal.style.display = 'none';
                appContainer.style.display = 'block';
                loggedInUserEmailSpan.textContent = loggedInUser;
                initializePage();
            } else {
                loginModal.style.display = 'flex';
                appContainer.style.display = 'none';
            }
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value.trim().toLowerCase();
            if (ALLOWED_EMAILS.includes(email)) {
                sessionStorage.setItem('loggedInUser', email);
                loginError.style.display = 'none';
                checkLogin();
            } else {
                loginError.style.display = 'block';
            }
        });

        logoutButton.addEventListener('click', () => {
            sessionStorage.removeItem('loggedInUser');
            tasks = []; // Clear tasks for security, or keep them if preferred
            if(calendar) calendar.removeAllEvents();
            checkLogin();
        });


        // --- Initialization ---
        function initializePage() {
            loadTasksFromLocalStorage();
            initializeCalendar();
            renderTasks(); // Initial render of tasks and calendar update
        }
        
        // --- LocalStorage ---
        function loadTasksFromLocalStorage() {
            const storedTasks = localStorage.getItem('tasks');
            if (storedTasks) {
                tasks = JSON.parse(storedTasks);
            } else {
                // Default tasks if localStorage is empty
                tasks = [
                    { id: 1, name: '×¢×™×¦×•×‘ ×“×£ × ×—×™×ª×”', project: '××ª×¨ ×©×™×•×•×§×™', assignee: '×“× ×”', dueDate: '2024-06-15', status: '×‘×ª×”×œ×™×š', description: '×¢×™×¦×•×‘ ×¨××©×•× ×™ ×œ×¤×™ ×“×¨×™×©×•×ª ×”×œ×§×•×—' },
                    { id: 2, name: '×¤×™×ª×•×— API ×œ××©×ª××©×™×', project: '××¢×¨×›×ª × ×™×”×•×œ ×¤× ×™××™×ª', assignee: '×™×•×¡×™', dueDate: '2024-07-01', status: '×—×“×©', description: 'API ×œ×¨×™×©×•× ×•×”×ª×—×‘×¨×•×ª ××©×ª××©×™×' },
                    { id: 3, name: '×‘×“×™×§×•×ª ×§×‘×œ×”', project: '××¤×œ×™×§×¦×™×™×ª ××•×‘×™×™×œ', assignee: '×¦×•×•×ª QA', dueDate: '2024-05-30', status: '×”×•×©×œ×', description: '×‘×“×™×§×•×ª ××§×™×¤×•×ª ×œ×¤× ×™ ×”×©×§×”' }
                ];
            }
        }

        function saveTasksToLocalStorage() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }

        // --- Calendar ---
        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'he', // Hebrew localization
                headerToolbar: {
                    start: 'title', // will be moved to right by CSS
                    center: 'dayGridMonth,timeGridWeek,timeGridDay',
                    end: 'today prev,next' // will be moved to left by CSS
                },
                events: [], // Will be populated by mapTasksToCalendarEvents
                editable: false, // For now, not allowing drag/drop editing
                eventDidMount: function(info) {
                    // Add tooltip or custom rendering if needed
                },
                direction: 'rtl' // Set calendar direction to RTL
            });
            calendar.render();
        }

        function mapTasksToCalendarEvents(tasksToMap) {
            return tasksToMap.filter(task => task.dueDate).map(task => ({
                id: task.id.toString(),
                title: task.name,
                start: task.dueDate,
                allDay: true, // Assuming tasks are for the whole day
                backgroundColor: getEventColorByStatus(task.status),
                borderColor: getEventColorByStatus(task.status),
                extendedProps: {
                    project: task.project,
                    assignee: task.assignee,
                    status: task.status
                }
            }));
        }
        
        function getEventColorByStatus(status) {
            switch (status) {
                case '×—×“×©': return '#6366F1'; // Indigo-500
                case '×‘×ª×”×œ×™×š': return '#F59E0B'; // Amber-500
                case '×”×•×©×œ×': return '#10B981'; // Green-500
                case '×‘×”××ª× ×”': return '#EAB308'; // Yellow-500
                case '×‘×•×˜×œ': return '#EF4444'; // Red-500
                default: return '#6B7280'; // Gray-500
            }
        }

        function updateCalendarEvents() {
            if (calendar) {
                const calendarEvents = mapTasksToCalendarEvents(tasks);
                calendar.removeAllEvents();
                calendar.addEventSource(calendarEvents);
            }
        }

        // --- Task Rendering and Filtering/Sorting ---
        function renderTasks() {
            tasksTableBody.innerHTML = ''; 
            
            let filteredTasks = [...tasks];

            // Apply filters
            const projectFilter = filterProjectInput.value.toLowerCase();
            const assigneeFilter = filterAssigneeInput.value.toLowerCase();
            const statusFilter = filterStatusSelect.value;

            if (projectFilter) {
                filteredTasks = filteredTasks.filter(task => task.project && task.project.toLowerCase().includes(projectFilter));
            }
            if (assigneeFilter) {
                filteredTasks = filteredTasks.filter(task => task.assignee && task.assignee.toLowerCase().includes(assigneeFilter));
            }
            if (statusFilter) {
                filteredTasks = filteredTasks.filter(task => task.status === statusFilter);
            }

            // Apply sorting
            const sortBy = sortBySelect.value;
            if (sortBy) {
                filteredTasks.sort((a, b) => {
                    let valA = a[sortBy];
                    let valB = b[sortBy];

                    if (sortBy === 'dueDate') { // Date sorting
                        valA = a.dueDate ? new Date(a.dueDate) : new Date(0); // Handle undefined dates
                        valB = b.dueDate ? new Date(b.dueDate) : new Date(0);
                        return valA - valB;
                    }
                    if (typeof valA === 'string') {
                        return valA.toLowerCase().localeCompare(valB ? valB.toLowerCase() : '');
                    }
                    return (valA || 0) - (valB || 0); // Handle undefined or null for numeric sort
                });
            }


            if (filteredTasks.length === 0) {
                tasksTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">××™×Ÿ ××©×™××•×ª ×œ×”×¦×’×” ×œ×¤×™ ×”×¡×™× ×•×Ÿ ×”× ×•×›×—×™</td></tr>';
            } else {
                filteredTasks.forEach(task => {
                    const row = tasksTableBody.insertRow();
                    row.className = `border-b border-gray-200 hover:bg-gray-100 transition duration-150 ease-in-out ${task.status === '×”×•×©×œ×' ? 'line-through text-gray-500' : ''}`;
                    
                    row.insertCell().textContent = task.name;
                    row.insertCell().textContent = task.project || '-';
                    row.insertCell().textContent = task.assignee || '-';
                    row.insertCell().textContent = task.dueDate ? new Date(task.dueDate).toLocaleDateString('he-IL') : '×œ× ×”×•×’×“×¨';
                    
                    const statusCell = row.insertCell();
                    const statusBadge = document.createElement('span');
                    statusBadge.textContent = task.status;
                    statusBadge.className = `px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(task.status)}`;
                    statusCell.appendChild(statusBadge);

                    const actionsCell = row.insertCell();
                    actionsCell.className = 'py-3 px-6 text-left whitespace-nowrap';

                    const editButton = document.createElement('button');
                    editButton.innerHTML = 'âœï¸'; 
                    editButton.title = '×¢×¨×•×š ××©×™××”';
                    editButton.className = 'text-yellow-500 hover:text-yellow-700 font-bold py-1 px-2 rounded text-lg ml-2 transition duration-150';
                    editButton.onclick = () => openEditModal(task.id);
                    actionsCell.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = 'ğŸ—‘ï¸'; 
                    deleteButton.title = '××—×§ ××©×™××”';
                    deleteButton.className = 'text-red-500 hover:text-red-700 font-bold py-1 px-2 rounded text-lg ml-2 transition duration-150';
                    deleteButton.onclick = () => deleteTask(task.id);
                    actionsCell.appendChild(deleteButton);
                    
                    if (task.status !== '×”×•×©×œ×') {
                        const completeButton = document.createElement('button');
                        completeButton.innerHTML = 'âœ”ï¸'; 
                        completeButton.title = '×¡××Ÿ ×›×”×•×©×œ×';
                        completeButton.className = 'text-green-500 hover:text-green-700 font-bold py-1 px-2 rounded text-lg transition duration-150';
                        completeButton.onclick = () => toggleCompleteTask(task.id);
                        actionsCell.appendChild(completeButton);
                    }
                });
            }
            taskCountSpan.textContent = filteredTasks.length;
            updateCalendarEvents(); // Update calendar whenever tasks are rendered/filtered
            saveTasksToLocalStorage(); // Save changes
        }
        
        function getStatusClass(status) {
            switch (status) {
                case '×—×“×©': return 'status-new';
                case '×‘×ª×”×œ×™×š': return 'status-in-progress';
                case '×”×•×©×œ×': return 'status-completed';
                case '×‘×”××ª× ×”': return 'status-pending';
                case '×‘×•×˜×œ': return 'status-cancelled';
                default: return 'bg-gray-200 text-gray-800';
            }
        }

        // --- Task Modal Logic ---
        function openTaskModal(taskToEdit = null) {
            taskForm.reset(); 
            if (taskToEdit) {
                modalTitle.textContent = '×¢×¨×•×š ××©×™××”';
                taskIdInput.value = taskToEdit.id;
                document.getElementById('taskName').value = taskToEdit.name;
                document.getElementById('taskProject').value = taskToEdit.project || '';
                document.getElementById('taskAssignee').value = taskToEdit.assignee || '';
                document.getElementById('taskDueDate').value = taskToEdit.dueDate || '';
                document.getElementById('taskStatus').value = taskToEdit.status;
                document.getElementById('taskDescription').value = taskToEdit.description || '';
            } else {
                modalTitle.textContent = '×”×•×¡×£ ××©×™××” ×—×“×©×”';
                taskIdInput.value = ''; 
            }
            taskModal.style.display = 'block';
        }

        function openEditModal(id) {
            const taskToEdit = tasks.find(task => task.id === id);
            if (taskToEdit) {
                openTaskModal(taskToEdit);
            }
        }
        
        function closeModal() {
            taskModal.style.display = 'none';
        }

        taskForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const id = taskIdInput.value ? parseInt(taskIdInput.value) : null;
            const name = document.getElementById('taskName').value;
            const project = document.getElementById('taskProject').value;
            const assignee = document.getElementById('taskAssignee').value;
            const dueDate = document.getElementById('taskDueDate').value;
            const status = document.getElementById('taskStatus').value;
            const description = document.getElementById('taskDescription').value;

            if (id) { 
                const taskIndex = tasks.findIndex(task => task.id === id);
                if (taskIndex > -1) {
                    tasks[taskIndex] = { ...tasks[taskIndex], name, project, assignee, dueDate, status, description };
                }
            } else { 
                const newId = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
                tasks.push({ id: newId, name, project, assignee, dueDate, status, description });
            }
            renderTasks();
            closeModal();
        });

        function deleteTask(id) {
            // For a real app, use a custom confirmation modal instead of console.log
            console.log(`×‘×§×©×” ×œ××—×™×§×ª ××©×™××” ${id}. ×‘×¤×•×¢×œ, ×›×“××™ ×œ×”×•×¡×™×£ ×›××Ÿ ×“×™××œ×•×’ ××™×©×•×¨.`);
            tasks = tasks.filter(task => task.id !== id);
            renderTasks();
        }

        function toggleCompleteTask(id) {
            const taskIndex = tasks.findIndex(task => task.id === id);
            if (taskIndex > -1) {
                tasks[taskIndex].status = (tasks[taskIndex].status === '×”×•×©×œ×') ? '×‘×ª×”×œ×™×š' : '×”×•×©×œ×';
                renderTasks();
            }
        }
        
        // Event listeners
        openModalButton.onclick = () => openTaskModal();
        closeButton.onclick = closeModal;
        cancelButton.onclick = closeModal;
        window.onclick = function(event) { 
            if (event.target == taskModal) {
                closeModal();
            }
        }

        filterProjectInput.addEventListener('input', renderTasks);
        filterAssigneeInput.addEventListener('input', renderTasks);
        filterStatusSelect.addEventListener('change', renderTasks);
        sortBySelect.addEventListener('change', renderTasks);

        // Initial check for login status
        checkLogin();
    </script>
</body>
</html>
